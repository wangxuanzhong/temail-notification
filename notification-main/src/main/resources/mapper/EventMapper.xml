<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.syswin.temail.notification.main.infrastructure.EventMapper">
  <resultMap id="EventMap" type="com.syswin.temail.notification.main.domains.Event">
    <id column="id" jdbcType="BIGINT" property="id"/>
    <result column="event_seq_id" jdbcType="BIGINT" property="eventSeqId"/>
    <result column="event_type" jdbcType="INTEGER" property="eventType"/>
    <result column="msg_id" jdbcType="VARCHAR" property="msgId"/>
    <result column="parent_msg_id" jdbcType="VARCHAR" property="parentMsgId"/>
    <result column="seq_id" jdbcType="BIGINT" property="seqId"/>
    <result column="message" jdbcType="VARCHAR" property="message"/>
    <result column="from" jdbcType="VARCHAR" property="from"/>
    <result column="to" jdbcType="VARCHAR" property="to"/>
    <result column="group_temail" jdbcType="VARCHAR" property="groupTemail"/>
    <result column="temail" jdbcType="VARCHAR" property="temail"/>
    <result column="extend_param" jdbcType="VARCHAR" property="extendParam"/>
    <result column="timestamp" jdbcType="BIGINT" property="timestamp"/>
  </resultMap>

  <sql id="baseField">
    `id`, `event_seq_id`, `event_type`, `msg_id`, `parent_msg_id`, `from`, `to`, `group_temail`, `temail`, `extend_param`, `timestamp`
  </sql>

  <insert id="insert" parameterType="com.syswin.temail.notification.main.domains.Event">
    INSERT INTO `event`
    (`event_seq_id`, `event_type`, `msg_id`, `parent_msg_id`, `seq_id`, `message`, `from`, `to`, `group_temail`, `temail`, `extend_param`,
    `timestamp`)
    VALUES
    (#{eventSeqId}, #{eventType}, #{msgId}, #{parentMsgId}, #{seqId}, #{message}, #{from}, #{to}, #{groupTemail}, #{temail}, #{extendParam},
    #{timestamp})
  </insert>

  <select id="selectByTo" resultMap="EventMap">
    SELECT
    <include refid="baseField"/>
    FROM `event`
    WHERE `to` = #{to} AND parent_msg_id IS NULL
    <if test="begin != null">AND event_seq_id > #{begin}</if>
    <if test="end != null">AND event_seq_id <![CDATA[<=]]> #{end}</if>
    ORDER BY `event_seq_id`
  </select>

  <select id="selectPulledEvent" resultMap="EventMap">
    SELECT
    <include refid="baseField"/>
    FROM `event`
    WHERE `from` = #{from} AND `to` = #{to} AND `event_type` = #{eventType} AND `msg_id` = #{msgId}
  </select>

  <select id="selectReplyEvents" resultMap="EventMap">
    SELECT
    <include refid="baseField"/>
    FROM `event`
    WHERE `to` = #{to} AND parent_msg_id = #{parentMsgId}
    <if test="begin != null">AND event_seq_id > #{begin}</if>
    <if test="end != null">AND event_seq_id <![CDATA[<=]]> #{end}</if>
    ORDER BY `event_seq_id`
  </select>
</mapper>