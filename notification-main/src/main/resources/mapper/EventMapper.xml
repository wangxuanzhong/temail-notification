<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.syswin.temail.notification.main.infrastructure.EventMapper">
  <resultMap id="EventMap" type="com.syswin.temail.notification.main.domains.Event">
    <id column="id" jdbcType="BIGINT" property="id"/>
    <result column="event_seq_id" jdbcType="BIGINT" property="eventSeqId"/>
    <result column="event_type" jdbcType="INTEGER" property="eventType"/>
    <result column="msg_id" jdbcType="VARCHAR" property="msgId"/>
    <result column="parent_msg_id" jdbcType="VARCHAR" property="parentMsgId"/>
    <result column="seq_id" jdbcType="BIGINT" property="seqId"/>
    <result column="message" jdbcType="VARCHAR" property="message"/>
    <result column="from" jdbcType="VARCHAR" property="from"/>
    <result column="to" jdbcType="VARCHAR" property="to"/>
    <result column="group_temail" jdbcType="VARCHAR" property="groupTemail"/>
    <result column="temail" jdbcType="VARCHAR" property="temail"/>
    <result column="extend_param" jdbcType="VARCHAR" property="extendParam"/>
    <result column="timestamp" jdbcType="BIGINT" property="timestamp"/>
  </resultMap>

  <sql id="baseField">
    `id`, `event_seq_id`, `event_type`, `msg_id`, `parent_msg_id`, `from`, `to`, `group_temail`, `temail`, `extend_param`, `timestamp`
  </sql>

  <insert id="insert" parameterType="com.syswin.temail.notification.main.domains.Event">
    INSERT INTO `event`
    (`event_seq_id`, `event_type`, `msg_id`, `parent_msg_id`, `from`, `to`, `group_temail`, `temail`, `extend_param`,
    `timestamp`)
    VALUES
    (#{eventSeqId}, #{eventType}, #{msgId}, #{parentMsgId}, #{from}, #{to}, #{groupTemail}, #{temail}, #{extendParam},
    #{timestamp})
  </insert>

  <select id="selectEventsByTo" resultMap="EventMap">
    SELECT
    <include refid="baseField"/>
    FROM `event`
    WHERE `to` = #{to}
    <choose>
      <when test="parentMsgId == null or parentMsgId == ''">
        AND `event_type` != ${@com.syswin.temail.notification.main.domains.Event$EventType@REPLY.getValue()}
      </when>
      <otherwise>
        AND parent_msg_id = #{parentMsgId}
      </otherwise>
    </choose>
    <if test="begin != null">AND event_seq_id > #{begin}</if>
    <if test="end != null">AND event_seq_id <![CDATA[<=]]> #{end}</if>
    ORDER BY `event_seq_id`
  </select>

  <select id="selectEvent" parameterType="com.syswin.temail.notification.main.domains.Event" resultMap="EventMap">
    SELECT
    <include refid="baseField"/>
    FROM `event`
    WHERE `from` = #{from} AND `to` = #{to} AND `event_type` = #{eventType} AND `msg_id` = #{msgId}
  </select>

  <select id="deleteReplyEvents" parameterType="com.syswin.temail.notification.main.domains.Event">
    DELETE FROM `event`
    WHERE `event_type` = #{eventType} AND `to` = #{to} AND event_seq_id <![CDATA[<]]> #{eventSeqId}
    <if test="groupTemail != null">AND group_temail = #{groupTemail}</if>
  </select>
</mapper>